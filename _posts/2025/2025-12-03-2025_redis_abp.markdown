---
layout: page
title: ASP.NET Core + ABP ä½¿ç”¨ Redis çš„æœ€ä½³å®è·µï¼šè¿æ¥å¤ç”¨ã€ç¼“å­˜ã€Data Protection å¯†é’¥å…±äº«ä¸åˆ†å¸ƒå¼é”å®Œæ•´é…ç½®ç¤ºä¾‹
category: å·¥å…·
tags: ABP
---

åœ¨å®é™…ç”Ÿäº§ç¯å¢ƒä¸­ï¼ŒRedis ä¸ä»…ç”¨äºç¼“å­˜ï¼Œè¿˜ç»å¸¸æ‰¿æ‹…è¿æ¥å¤ç”¨ã€Session/Cookie åŠ è§£å¯†å¯†é’¥å…±äº«ï¼ˆData Protectionï¼‰ã€åˆ†å¸ƒå¼é”ç­‰æ ¸å¿ƒèŒè´£ã€‚æœ¬æ–‡è®°å½•äº†æˆ‘æœ€ç»ˆé‡‡ç”¨çš„ä¸€å¥—å®Œæ•´ Redis é…ç½®æ–¹æ¡ˆï¼Œå¹¶æ€»ç»“äº†ä¼˜åŒ–è¿‡ç¨‹ä¸­çš„å…³é”®ç‚¹ï¼Œä¾›å›¢é˜ŸåŠä»–äººå‚è€ƒã€‚

---

## ğŸ§± ä¸€ã€ä¸ºä»€ä¹ˆè¦ä¼˜åŒ– Redis é…ç½®ï¼Ÿ

åœ¨å¾®æœåŠ¡æˆ–å¤šå®ä¾‹éƒ¨ç½²åœºæ™¯ä¸­ï¼ŒRedis é€šå¸¸æ‰¿æ‹…ä»¥ä¸‹èŒè´£ï¼š

### **1. ä½œä¸ºåº”ç”¨ç¼“å­˜ï¼ˆDistributed Cacheï¼‰**

æä¾›å¯¹è±¡ç¼“å­˜ã€é…ç½®ç¼“å­˜ç­‰ã€‚

### **2. å…±äº« Data Protection å¯†é’¥ï¼ˆè§£å†³ Cookie è§£å¯†å¤±è´¥é—®é¢˜ï¼‰**

é¿å…å¤šå®ä¾‹ä¹‹é—´çš„è®¤è¯ Cookie è§£å¯†ä¸ä¸€è‡´ã€‚

### **3. åˆ†å¸ƒå¼é”**

ä¿è¯ä¸šåŠ¡åœ¨å¤šå®ä¾‹ä¸­æ‹¥æœ‰å¼ºä¸€è‡´æ€§æ§åˆ¶èƒ½åŠ›ã€‚

### **4. é¿å… Redis è¿æ¥è¿‡å¤š**

å¦‚æœæ¯ä¸ªç»„ä»¶éƒ½åˆ›å»ºä¸€ä¸ª ConnectionMultiplexerï¼Œä¼šå¯¼è‡´è¿æ¥æ•°çˆ†ç‚¸ã€æ€§èƒ½ä¸‹é™ã€‚

---

## ğŸ§© äºŒã€æ ¸å¿ƒç›®æ ‡ä¸æœ€ç»ˆæ–¹æ¡ˆ

ä¸ºäº†è§£å†³ä»¥ä¸Šé—®é¢˜ï¼Œè¿™æ¬¡æ”¹é€ çš„ç›®æ ‡æ˜¯ï¼š

* **åªåˆ›å»ºä¸€ä¸ª Redis ConnectionMultiplexer å®ä¾‹å¹¶å¤ç”¨ï¼ˆå…±äº«è¿æ¥ï¼‰**
* **å°†è¿æ¥æ”¾å…¥ DI å•ä¾‹**
* **è®©å¾®è½¯çš„ RedisCacheOptionsã€ABP çš„ç¼“å­˜ç³»ç»ŸåŒæ—¶å¤ç”¨è¿™ä¸ªè¿æ¥**
* **åœ¨ç”Ÿäº§ç¯å¢ƒä½¿ç”¨ Redis ä½œä¸º Data Protection çš„å¯†é’¥ä»“åº“**
* **ä½¿ç”¨ Medallion.Threading å®ç° Redis åˆ†å¸ƒå¼é”**

æœ€ç»ˆçš„é…ç½®ä»£ç å¦‚ä¸‹ï¼ˆå·²åœ¨ç”Ÿäº§éªŒè¯ç¨³å®šï¼‰ï¼š

---

## ğŸŸ¦ ä¸‰ã€æœ€ç»ˆçš„ Redis é…ç½®ä»£ç ï¼ˆå¯ç›´æ¥å¤ç”¨ï¼‰

```csharp
#region ç¼“å­˜
var configurationOptions = ConfigurationOptions.Parse(configuration["Redis:Configuration"]);
// å¯é€‰:æ·»åŠ æ›´å¤šé…ç½®
//configurationOptions.AbortOnConnectFail = false;
//configurationOptions.ConnectTimeout = 10000;
//configurationOptions.SyncTimeout = 3000;
//configurationOptions.ConnectRetry = 3;
//configurationOptions.KeepAlive = 60;

// å…±ç”¨ä¸€ä¸ªè¿æ¥å®ä¾‹
var connection = ConnectionMultiplexer.Connect(configurationOptions);

// æ³¨å†Œå•ä¾‹å¹¶è¾“å‡ºè¿æ¥äº‹ä»¶æ—¥å¿—
context.Services.AddSingleton<IConnectionMultiplexer>(sp =>
{
    var loggerFactory = sp.GetRequiredService<ILoggerFactory>();
    var logger = loggerFactory.CreateLogger("RedisConn");
    logger?.LogInformation($"Redis Logger");

    connection.ConnectionFailed += (s, e) =>
    {
        logger?.LogError($"Redis è¿æ¥å¤±è´¥: {e.Exception?.Message}");
    };
    connection.ConnectionRestored += (s, e) =>
    {
        logger?.LogInformation($"Redis è¿æ¥æ¢å¤: {e.FailureType}");
    };

    return connection;
});

// é…ç½®å¾®è½¯çš„ RedisCacheOptions (ä¸æ˜¯ ABP çš„)
context.Services.Configure<Microsoft.Extensions.Caching.StackExchangeRedis.RedisCacheOptions>(options =>
{
    options.ConnectionMultiplexerFactory = () => Task.FromResult((IConnectionMultiplexer)connection);
});

// é…ç½® ABP çš„ç¼“å­˜é€‰é¡¹
Configure<AbpDistributedCacheOptions>(options =>
{
    options.KeyPrefix = "warehouse:";
    options.GlobalCacheEntryOptions = new DistributedCacheEntryOptions()
    {
        AbsoluteExpirationRelativeToNow = TimeSpan.FromMinutes(60),
        //SlidingExpiration = TimeSpan.FromMinutes(60)
    };
});

// Data Protectionï¼šå…±äº«åŠ å¯†å¯†é’¥ï¼ˆä»…ç”Ÿäº§ç¯å¢ƒï¼‰
if (!hostingEnvironment.IsDevelopment())
{
    context.Services
        .AddDataProtection()
        .SetApplicationName(Assembly.GetExecutingAssembly().FullName)
        .PersistKeysToStackExchangeRedis(connection, "WarehouseModule-Protection-Keys");
}
#endregion

#region abp DistributedLock åˆ†å¸ƒå¼é”
context.Services.AddSingleton<Medallion.Threading.IDistributedLockProvider>(sp =>
{
    return new RedisDistributedSynchronizationProvider(connection.GetDatabase());
});
#endregion
```

---

## ğŸ§  å››ã€å…³é”®ç‚¹è§£æï¼ˆæ€»ç»“è®¨è®ºå†…å®¹ï¼‰

### ### **1. å…¨å±€å¤ç”¨ Redis è¿æ¥**

`ConnectionMultiplexer` æ˜¯ä¸€ä¸ªé‡é‡çº§å¯¹è±¡ï¼Œå®˜æ–¹æ˜ç¡®å»ºè®®ï¼š

> åº”ä½œä¸ºå…¨å±€å•ä¾‹å¤ç”¨ï¼Œè€Œä¸æ˜¯é¢‘ç¹åˆ›å»ºã€‚

é€šè¿‡å•ä¾‹æ¨¡å¼æ³¨å…¥ï¼Œé¿å…äº†åˆ›å»ºè¿‡å¤šè¿æ¥å¯¼è‡´çš„èµ„æºæµªè´¹ã€‚

---

### **2. Microsoft.RedisCache ä¸ ABP ç¼“å­˜ç»Ÿä¸€èµ°åŒä¸€ä¸ªè¿æ¥**

è¿™ä¸€æ­¥éå¸¸å…³é”®ï¼š

```csharp
options.ConnectionMultiplexerFactory = () => Task.FromResult((IConnectionMultiplexer)connection);
```

å¾®è½¯çš„ RedisCache é»˜è®¤ä¼šè‡ªå·±åˆ›å»ºè¿æ¥ï¼Œæˆ‘ä»¬é€šè¿‡å·¥å‚æ–¹æ³•è®©å®ƒä½¿ç”¨æˆ‘ä»¬è‡ªå·±çš„ã€‚

---

### **3. ä½¿ç”¨ Redis ä¿å­˜ Data Protection å¯†é’¥ï¼ˆç”Ÿäº§ç¯å¢ƒå¿…é¡»ï¼‰**

å¦‚æœé¡¹ç›®éƒ¨ç½²ä¸ºå¤šå®ä¾‹ï¼Œå¿…é¡»å…±äº« Data Protection å¯†é’¥ï¼Œå¦åˆ™ä¼šå‡ºç°ï¼š

* ç™»å½•åé¡µé¢è·³å›ç™»å½•é¡µ
* Cookie æ— æ³•è§£å¯†
* ç”¨æˆ·è¢«é¢‘ç¹è¸¢ä¸‹çº¿

åœ¨ç”Ÿäº§ç¯å¢ƒä¸­ä½¿ç”¨ï¼š

```csharp
.PersistKeysToStackExchangeRedis(connection, "WarehouseModule-Protection-Keys");
```

è®©æ‰€æœ‰å®ä¾‹å…±äº«ç›¸åŒçš„å¯†é’¥ã€‚

---

### **4. ABP åˆ†å¸ƒå¼é”**

ä½¿ç”¨ Medallion.Threadingï¼š

```csharp
new RedisDistributedSynchronizationProvider(connection.GetDatabase());
```

è¿™è®©æˆ‘ä»¬èƒ½è½»æ¾å®ç°ï¼š

* ä¸²è¡ŒåŒ–å…³é”®ä¸šåŠ¡é€»è¾‘
* é˜²æ­¢å¹¶å‘å†™å…¥
* æ„å»ºç§’æ€ã€åº“å­˜æ‰£å‡ç­‰åŠŸèƒ½

---

## ğŸ¯ äº”ã€æœ€ç»ˆæ”¶ç›Š

| ä¼˜åŒ–é¡¹         | æ”¶ç›Š           |
| ----------- | ------------ |
| å¤ç”¨ Redis è¿æ¥ | é™ä½è¿æ¥æ•°ã€æå‡æ€§èƒ½   |
| ç»Ÿä¸€ç¼“å­˜ä½¿ç”¨åŒä¸€è¿æ¥  | é¿å…è¿æ¥çˆ†ç‚¸é—®é¢˜     |
| Redis ä¿å­˜å¯†é’¥  | å¤šå®ä¾‹ç¯å¢ƒä¸‹è®¤è¯ç¨³å®šå¯é  |
| ä½¿ç”¨åˆ†å¸ƒå¼é”      | æå‡å¹¶å‘ä¸€è‡´æ€§èƒ½åŠ›    |
| ç»“æ„æ¸…æ™°ã€å¯ç»´æŠ¤æ€§æ›´é«˜ | æ›´é€‚åˆå›¢é˜Ÿåä½œå’Œåº”ç”¨æ‰©å±• |

---

# ğŸ“Œ æ€»ç»“

è¿™æ¬¡ä¼˜åŒ–ä¸ä»…è§£å†³äº† Redis è¿æ¥ä¸ç»Ÿä¸€çš„é—®é¢˜ï¼Œè¿˜è®©æ•´ä¸ªç³»ç»Ÿå…·å¤‡äº†æ›´é«˜çš„ç¨³å®šæ€§å’Œå¯æ‰©å±•æ€§ã€‚
é€šè¿‡ç»Ÿä¸€çš„è¿æ¥å¤ç”¨ã€ç¼“å­˜é…ç½®ã€Data Protection å¯†é’¥å…±äº«ä»¥åŠåˆ†å¸ƒå¼é”èƒ½åŠ›ï¼Œé¡¹ç›®åœ¨åˆ†å¸ƒå¼éƒ¨ç½²ç¯å¢ƒä¸‹èƒ½å¤Ÿæ›´åŠ ç¨³å®šã€é«˜æ•ˆè¿è¡Œã€‚

å¦‚æœä½ åœ¨ä½¿ç”¨ ABPã€Docker/K8sã€å¤šå®ä¾‹éƒ¨ç½²æˆ–å¾®æœåŠ¡æ¶æ„ï¼Œé‚£ä¹ˆè¿™ä¸ªæ–¹æ¡ˆå®Œå…¨å€¼å¾—é‡‡ç”¨ã€‚
