---
layout: page
title: ASP.NET Core å®ç°å¸¦ç­¾åçš„å®‰å…¨å¯¼å‡ºä¸‹è½½ï¼ˆæ”¯æŒå¤æ‚ JSON å‚æ•°ï¼‰
category: æŠ€æœ¯
tags: net
---

åœ¨æ—¥å¸¸åå°ç³»ç»Ÿä¸­ï¼Œâ€œå¯¼å‡ºæ•°æ®â€å‡ ä¹æ˜¯æ ‡é…åŠŸèƒ½ä¹‹ä¸€ã€‚
ç„¶è€Œéšç€å¯¼å‡ºé€»è¾‘è¶Šæ¥è¶Šå¤æ‚ï¼Œæ¯”å¦‚ç­›é€‰æ¡ä»¶ã€æ—¶é—´åŒºé—´ã€åˆ†é¡µå‚æ•°ã€å­—æ®µé€‰æ‹©ç­‰ï¼Œä¼ ç»Ÿçš„â€œå‰ç«¯ POST è¯·æ±‚ + Blob ä¸‹è½½â€æ–¹å¼å°±å¼€å§‹æ˜¾å¾—ç¬¨é‡ã€‚

æœ¬æ–‡å°†å¸¦ä½ ä¸€æ­¥æ­¥å®ç°ä¸€ä¸ª**é«˜å®‰å…¨æ€§ã€å¯æ‰©å±•ã€æ”¯æŒå¤æ‚ JSON å‚æ•°çš„å¯¼å‡ºä¸‹è½½æœºåˆ¶**ï¼Œ
å¹¶ä¸”å¯ä»¥å®ç°â€œç‚¹å‡»å³ä¸‹è½½â€çš„é¡ºç•…ä½“éªŒã€‚

---

## ğŸ§© ä¸€ã€å¸¸è§å¯¼å‡ºæ–¹å¼çš„é—®é¢˜

### 1ï¸âƒ£ ç›´æ¥è¿”å›æ–‡ä»¶æµï¼ˆBlobï¼‰

å‰ç«¯é€šè¿‡ `axios.post()` è·å– `blob`ï¼Œç„¶åæ‰‹åŠ¨è§¦å‘ä¸‹è½½ï¼š

```js
axios({
  url: '/api/export',
  method: 'post',
  data: params,
  responseType: 'blob'
})
```

**é—®é¢˜ï¼š**

* å‰ç«¯éœ€è¦ç­‰å¾…æ•´ä¸ªæ–‡ä»¶ç”Ÿæˆå®Œå†ä¿å­˜ï¼›
* æ— æ³•æ˜¾ç¤ºâ€œç«‹å³ä¸‹è½½â€çš„ä½“éªŒï¼›
* å¯¹å¤§æ–‡ä»¶æä¸å‹å¥½ï¼ˆéœ€å ç”¨å¤§é‡å†…å­˜ï¼‰ï¼›
* é“¾æ¥ä¸èƒ½ç›´æ¥åˆ†äº«æˆ–å¤ç”¨ã€‚

---

## âœ… äºŒã€ç›®æ ‡æ–¹æ¡ˆ

æˆ‘ä»¬çš„ç›®æ ‡æ˜¯å®ç°ï¼š

> æ”¯æŒå¤æ‚ JSON å‚æ•°ã€å¸¦æƒé™éªŒè¯ã€ä¸´æ—¶æœ‰æ•ˆã€æµè§ˆå™¨ç›´æ¥ä¸‹è½½æ–‡ä»¶ï¼Œè€Œä¸å ç”¨å‰ç«¯å†…å­˜ã€‚

å®ç°æ€è·¯æ˜¯é‡‡ç”¨â€œä¸¤æ­¥å¼å¯¼å‡ºæœºåˆ¶â€ï¼š

1ï¸âƒ£ **å‡†å¤‡é˜¶æ®µ**
å‰ç«¯ä¸Šä¼ å¯¼å‡ºå‚æ•°ï¼ˆå¤æ‚ JSONï¼‰ï¼Œåç«¯æ ¡éªŒå¹¶ç”Ÿæˆä¸€ä¸ªä¸´æ—¶ç­¾åä¸‹è½½é“¾æ¥ã€‚

2ï¸âƒ£ **ä¸‹è½½é˜¶æ®µ**
å‰ç«¯æ‹¿åˆ°ç­¾å URL åç›´æ¥ `window.open(url)`ï¼Œæµè§ˆå™¨ç«‹å³è§¦å‘ä¸‹è½½ã€‚
åç«¯é€šè¿‡ç­¾åéªŒè¯å’Œç¼“å­˜å‚æ•°ï¼Œå®æ—¶ç”Ÿæˆå¯¼å‡ºå†…å®¹ã€‚

---

## âœ… ä¸‰ã€åç«¯å®ç°ï¼ˆASP.NET Coreï¼‰

### Step 1ï¸âƒ£ï¼šå‡†å¤‡æ¥å£ï¼ˆæ¥æ”¶å‚æ•°å¹¶ç”Ÿæˆç­¾åé“¾æ¥ï¼‰

```csharp
using System.Security.Cryptography;
using System.Text;
using Microsoft.AspNetCore.Mvc;

[ApiController]
[Route("api/[controller]")]
public class ExportController : ControllerBase
{
    private const string SecretKey = "ExportDownloadSecret";
    private static readonly Dictionary<string, string> ExportParameterCache = new();

    [HttpPost("prepare")]
    public IActionResult PrepareExport([FromBody] ExportRequestDto request)
    {
        var exportId = Guid.NewGuid().ToString("N");

        // ç¼“å­˜å‚æ•°ï¼ˆå®é™…å¯å­˜ Redis æˆ–æ•°æ®åº“ï¼‰
        ExportParameterCache[exportId] = System.Text.Json.JsonSerializer.Serialize(request);

        var expire = DateTimeOffset.UtcNow.AddMinutes(5).ToUnixTimeSeconds();
        var sig = Sign($"{exportId}:{expire}");

        var url = $"{Request.Scheme}://{Request.Host}/api/export/download?id={exportId}&exp={expire}&sig={sig}";
        return Ok(new { url });
    }

    private string Sign(string input)
    {
        using var hmac = new HMACSHA256(Encoding.UTF8.GetBytes(SecretKey));
        var hash = hmac.ComputeHash(Encoding.UTF8.GetBytes(input));
        return Convert.ToBase64String(hash).Replace('+', '-').Replace('/', '_').TrimEnd('=');
    }
}

public class ExportRequestDto
{
    public string Type { get; set; }
    public DateTime StartTime { get; set; }
    public DateTime EndTime { get; set; }
    public string[] SelectedColumns { get; set; }
    public int? UserId { get; set; }
}
```

---

### Step 2ï¸âƒ£ï¼šä¸‹è½½æ¥å£ï¼ˆæ ¡éªŒç­¾åå¹¶åŠ¨æ€ç”Ÿæˆæ–‡ä»¶ï¼‰

```csharp
[HttpGet("download")]
public IActionResult Download(string id, long exp, string sig)
{
    var now = DateTimeOffset.UtcNow.ToUnixTimeSeconds();
    if (now > exp)
        return BadRequest("é“¾æ¥å·²è¿‡æœŸ");

    var expectedSig = Sign($"{id}:{exp}");
    if (sig != expectedSig)
        return Unauthorized("ç­¾åæ— æ•ˆ");

    if (!ExportParameterCache.TryGetValue(id, out var json))
        return NotFound("å¯¼å‡ºä»»åŠ¡ä¸å­˜åœ¨æˆ–å·²è¿‡æœŸ");

    var dto = System.Text.Json.JsonSerializer.Deserialize<ExportRequestDto>(json);

    // åŠ¨æ€ç”Ÿæˆ Excel æ–‡ä»¶ï¼ˆç¤ºä¾‹ï¼‰
    var bytes = GenerateExcel(dto);
    var fileName = $"{dto.Type}-{DateTime.Now:yyyyMMddHHmmss}.xlsx";

    return File(bytes,
        "application/vnd.openxmlformats-officedocument.spreadsheetml.sheet",
        fileName);
}

private byte[] GenerateExcel(ExportRequestDto dto)
{
    using var ms = new MemoryStream();
    using var writer = new StreamWriter(ms);
    writer.WriteLine("ColumnA,ColumnB,ColumnC");
    writer.WriteLine($"From {dto.StartTime} To {dto.EndTime}");
    writer.WriteLine($"Selected: {string.Join(",", dto.SelectedColumns)}");
    writer.Flush();
    return ms.ToArray();
}
```

---

## âœ… å››ã€å‰ç«¯å®ç°ï¼ˆVue ç¤ºä¾‹ï¼‰

```js
async function exportData() {
  const exportParams = {
    type: 'student-report',
    startTime: '2025-11-01T00:00:00Z',
    endTime: '2025-11-05T00:00:00Z',
    selectedColumns: ['Name', 'Score', 'Class'],
    userId: 123,
  };

  // Step1: å…ˆæäº¤å‚æ•°ï¼Œè·å–ç­¾åä¸‹è½½ URL
  const { data } = await axios.post('/api/export/prepare', exportParams);

  // Step2: æ‰“å¼€ä¸‹è½½é“¾æ¥ï¼ˆæµè§ˆå™¨ç›´æ¥ä¸‹è½½ï¼‰
  window.open(data.url);
}
```

**æ•ˆæœï¼š**

* å¯¼å‡ºå‚æ•°å¤æ‚æ— å¦¨ï¼›
* é“¾æ¥ 5 åˆ†é’Ÿåè‡ªåŠ¨å¤±æ•ˆï¼›
* ç”¨æˆ·ç‚¹å‡»å³è§¦å‘ä¸‹è½½ï¼›
* ä¸éœ€ç­‰å¾… Blob åŠ è½½ï¼›
* æ–‡ä»¶å®æ—¶ç”Ÿæˆï¼Œæ— éœ€æå‰å­˜å‚¨ã€‚

---

## âœ… äº”ã€å®‰å…¨ä¸ä¼˜åŒ–å»ºè®®

| ä¼˜åŒ–æ–¹å‘            | è¯´æ˜                                              |
| --------------- | ----------------------------------------------- |
| ğŸ” **ç»‘å®šç”¨æˆ· ID**  | åœ¨ç­¾åä¸­åŠ å…¥ç”¨æˆ·æ ‡è¯†ï¼š`Sign($"{userId}:{exportId}:{exp}")` |
| ğŸ§  **å¼‚æ­¥å¯¼å‡º**     | å¯¹å¤§æ•°æ®é›†ï¼Œå»ºè®®ä½¿ç”¨åå°ä»»åŠ¡ï¼ˆå¦‚ Hangfireï¼‰å¼‚æ­¥ç”Ÿæˆæ–‡ä»¶                |
| ğŸ•’ **ç¼“å­˜æ¸…ç†**     | å®šæ—¶æ¸…ç†è¿‡æœŸå¯¼å‡ºå‚æ•°æˆ–ç”Ÿæˆçš„æ–‡ä»¶                                |
| â˜ï¸ **æ–‡ä»¶å­˜å‚¨**     | å¯¹å¤§å‹å¯¼å‡ºå¯å…ˆå­˜å…¥ OSS / S3ï¼Œè¿”å›ç­¾åä¸‹è½½é“¾æ¥                     |
| âš™ï¸ **HTTPS å¼ºåˆ¶** | é˜²æ­¢ç­¾åå‚æ•°è¢«ä¸­é—´äººçªƒå–                                    |

---

## âœ… å…­ã€æ–¹æ¡ˆä¼˜ç‚¹æ€»ç»“

| ç‰¹ç‚¹             | è¯´æ˜             |
| -------------- | -------------- |
| âœ… æ”¯æŒå¤æ‚ JSON å‚æ•° | ä¸å— URL é•¿åº¦é™åˆ¶    |
| âœ… å®‰å…¨å¯é          | ç­¾åéªŒè¯ + çŸ­æœŸæœ‰æ•ˆ    |
| âœ… ç‚¹å‡»å³ä¸‹         | æµè§ˆå™¨è‡ªåŠ¨å¤„ç†ä¸‹è½½ï¼Œä¸å å†…å­˜ |
| âœ… æ˜“æ‰©å±•          | å¯å¯¹æ¥å¼‚æ­¥ä»»åŠ¡ã€OSS ç­‰  |
| âœ… è½»é‡å®ç°         | æ— éœ€å¼•å…¥ç¬¬ä¸‰æ–¹åº“       |

---

## âœ… ä¸ƒã€æ€»ç»“

è¿™ç§â€œä¸¤æ­¥å¼å¯¼å‡º + ç­¾åä¸‹è½½â€çš„æ¨¡å¼ï¼Œ
ç»“åˆäº† **å®‰å…¨æ€§ã€æ˜“ç”¨æ€§å’Œæ€§èƒ½** çš„ä¼˜ç‚¹ï¼Œéå¸¸é€‚åˆç®¡ç†åå°æˆ– SaaS ç³»ç»Ÿä¸­çš„å¯¼å‡ºåŠŸèƒ½ã€‚

å‰ç«¯ä¸å¿…ç­‰å¾… blob æ–‡ä»¶ç”Ÿæˆï¼Œåç«¯ä¹Ÿé¿å…äº†ç›´æ¥æš´éœ²æ¥å£æˆ– tokenï¼Œ
å®ç°äº†çœŸæ­£æ„ä¹‰ä¸Šçš„ã€Œ**å®‰å…¨ã€å³ç‚¹å³ä¸‹ã€å¯æ§å¯¼å‡º**ã€ã€‚