---
layout: page
title: MySQL å¤šè¡¨è¿æ¥ + èšåˆæŸ¥è¯¢çš„æ€§èƒ½ä¼˜åŒ–å®è·µ
category: æŠ€æœ¯
tags: mysql
---

åœ¨å®é™…ä¸šåŠ¡å¼€å‘ä¸­ï¼Œå¤æ‚çš„ç»Ÿè®¡ç±» SQL æŸ¥è¯¢å¸¸å¸¸å› ä¸ºé¢‘ç¹çš„è¡¨è¿æ¥å’Œèšåˆæ“ä½œè€Œå¯¼è‡´æ€§èƒ½é—®é¢˜ã€‚æœ¬æ–‡é€šè¿‡ä¸€ä¸ªçœŸå®åœºæ™¯çš„ SQL æŸ¥è¯¢ï¼Œæ¼”ç¤ºå¦‚ä½•é€šè¿‡å…¬å…±è¡¨è¡¨è¾¾å¼ï¼ˆCTEï¼‰ã€é€»è¾‘æ‹†åˆ†ä¸ç»“æ„ä¼˜åŒ–ï¼Œæœ‰æ•ˆæå‡æŸ¥è¯¢æ€§èƒ½ã€‚


## ğŸ” èƒŒæ™¯ä¸é—®é¢˜æè¿°

åŸå§‹ SQL æŸ¥è¯¢ç”¨äºç»Ÿè®¡æ¯ä¸ªäº§å“åœ¨ä»“åº“ä¸­çš„å„ç§çŠ¶æ€ï¼ˆå¾…å…¥åº“ã€å·²å…¥åº“ã€å¾…å‡ºåº“ç­‰ï¼‰ä¸‹çš„æ•°é‡å’Œç®±æ•°ã€‚ç”±äºé€»è¾‘å¤æ‚ï¼Œæ¶‰åŠä¸‰ä¸ªè¡¨çš„å¤§é‡è¿æ¥ä¸èšåˆï¼Œå¯¼è‡´æ‰§è¡Œç¼“æ…¢ã€å¯ç»´æŠ¤æ€§å·®ã€‚

---

## âœ… ä¼˜åŒ–ç›®æ ‡

* å‡å°‘é‡å¤è¿æ¥ï¼Œæé«˜æ€§èƒ½
* æ‹†åˆ†é€»è¾‘ç»“æ„ï¼Œæå‡å¯è¯»æ€§
* æ”¯æŒåˆ†é¡µï¼Œé¿å…ä¸€æ¬¡åŠ è½½è¿‡å¤šæ•°æ®

---

## ğŸ›  ä¼˜åŒ–å…³é”®ç‚¹

### 1. ä½¿ç”¨ CTEï¼ˆå…¬å…±è¡¨è¡¨è¾¾å¼ï¼‰

å°†å¤šä¸ªèšåˆå­æŸ¥è¯¢ä¸­éƒ½ç”¨åˆ°çš„åŸºç¡€è¡¨è¿æ¥æ“ä½œæŠ½å‡ºæˆä¸€ä¸ª `BaseData`ï¼Œé¿å…é‡å¤è¿æ¥ã€‚

### 2. æ‹†åˆ†èšåˆé€»è¾‘

é’ˆå¯¹ä¸åŒçš„èšåˆç»Ÿè®¡éœ€æ±‚ï¼ˆå¦‚å¾…å…¥åº“æ•°ã€åœ¨åº“å¯ç”¨æ•°ã€å¾…å‡ºåº“æ•°ç­‰ï¼‰ï¼Œå•ç‹¬ä½¿ç”¨ä¸€ä¸ª CTE æ¥å¤„ç†ã€‚

### 3. ä¸»æŸ¥è¯¢ä¸­èšåˆæ‹¼æ¥ + åˆ†é¡µæ§åˆ¶

å°†æ‰€æœ‰èšåˆç»Ÿè®¡ LEFT JOIN å›ä¸»ç»Ÿè®¡è¡¨ï¼Œå¹¶é€šè¿‡ `LIMIT` è¿›è¡Œåˆ†é¡µæ§åˆ¶ã€‚

---

## ğŸ§¾ å®Œæ•´ä¼˜åŒ–åçš„ SQL æŸ¥è¯¢

```sql
WITH BaseData AS (
    SELECT
        rl.ProductId,
        whbox.WarehouseId,
        box.ShopId,
        box.ProductKindCount,
        whbox.ContainerBoxStatus,
        whbox.HasException,
        whbox.WarehouseType,
        whbox.IsLocked,
        whbox.InWarehouseCount,
        rl.ContainerCount,
        rl.AllowBound
    FROM warehouse_WarehouseBoxes whbox
    JOIN warehouse_Boxes box ON whbox.BoxId = box.Id
    JOIN warehouse_BoxProductRls rl ON box.Id = rl.BoxId
    WHERE box.ProductKindCount > 0
        AND whbox.WarehouseType = 1
        AND (7140703588798103553 = 0 OR box.ShopId = 7140703588798103553)
        AND (0 = 0 OR rl.ProductId = 0)
),
inv AS (
    SELECT ProductId, WarehouseId, COUNT(1) AS BarCount
    FROM BaseData
    WHERE ContainerBoxStatus IS NOT NULL AND HasException = 0
    GROUP BY ProductId, WarehouseId
),
inw AS (
    SELECT ProductId, WarehouseId, SUM(ContainerCount) AS AwaitInWarehouseCount
    FROM BaseData
    WHERE AllowBound = 1 AND ContainerBoxStatus BETWEEN 10 AND 19
    GROUP BY ProductId, WarehouseId
),
inwb AS (
    SELECT ProductId, WarehouseId, COUNT(1) AS AwaitInWarehouseBoxCount
    FROM BaseData
    WHERE ContainerBoxStatus BETWEEN 10 AND 19
    GROUP BY ProductId, WarehouseId
),
onuw AS (
    SELECT ProductId, WarehouseId, SUM(ContainerCount) AS OnWarehouseUsableCount
    FROM BaseData
    WHERE AllowBound = 1 AND ContainerBoxStatus = 20 AND IsLocked = FALSE
    GROUP BY ProductId, WarehouseId
),
onuwb AS (
    SELECT ProductId, WarehouseId, COUNT(1) AS OnWarehouseUsableBoxCount
    FROM BaseData
    WHERE ContainerBoxStatus BETWEEN 20 AND 39 AND InWarehouseCount IS NOT NULL
    GROUP BY ProductId, WarehouseId
),
ouw AS (
    SELECT ProductId, WarehouseId, SUM(ContainerCount) AS AwaitOutWarehouseCount
    FROM BaseData
    WHERE AllowBound = 1 AND ContainerBoxStatus BETWEEN 40 AND 49
    GROUP BY ProductId, WarehouseId
),
ouwb AS (
    SELECT ProductId, WarehouseId, COUNT(1) AS AwaitOutWarehouseBoxCount
    FROM BaseData
    WHERE ContainerBoxStatus BETWEEN 40 AND 49
    GROUP BY ProductId, WarehouseId
)
SELECT
    inv.ProductId,
    inv.WarehouseId,
    inw.AwaitInWarehouseCount,
    inwb.AwaitInWarehouseBoxCount,
    onuw.OnWarehouseUsableCount,
    onuwb.OnWarehouseUsableBoxCount,
    ouw.AwaitOutWarehouseCount,
    ouwb.AwaitOutWarehouseBoxCount
FROM inv
LEFT JOIN inw ON inw.ProductId = inv.ProductId AND inw.WarehouseId = inv.WarehouseId
LEFT JOIN inwb ON inwb.ProductId = inv.ProductId AND inwb.WarehouseId = inv.WarehouseId
LEFT JOIN onuw ON onuw.ProductId = inv.ProductId AND onuw.WarehouseId = inv.WarehouseId
LEFT JOIN onuwb ON onuwb.ProductId = inv.ProductId AND onuwb.WarehouseId = inv.WarehouseId
LEFT JOIN ouw ON ouw.ProductId = inv.ProductId AND ouw.WarehouseId = inv.WarehouseId
LEFT JOIN ouwb ON ouwb.ProductId = inv.ProductId AND ouwb.WarehouseId = inv.WarehouseId
LIMIT 0, 10;
```

---

## ğŸ“Œ é™„åŠ ä¼˜åŒ–å»ºè®®

1. **æ·»åŠ ç´¢å¼•**ï¼šç¡®ä¿ä»¥ä¸‹å­—æ®µå­˜åœ¨ BTree ç´¢å¼•ä»¥æé«˜ JOIN ä¸ WHERE æ€§èƒ½ï¼š

   * `warehouse_Boxes.Id`
   * `warehouse_BoxProductRls.BoxId`
   * `warehouse_BoxProductRls.ProductId`
   * `warehouse_WarehouseBoxes.BoxId`
   * `warehouse_WarehouseBoxes.ContainerBoxStatus`
   * `warehouse_WarehouseBoxes.IsLocked`
   * `warehouse_WarehouseBoxes.HasException`
   * `warehouse_WarehouseBoxes.WarehouseType`
   * `warehouse_Boxes.ShopId`
   * `warehouse_Boxes.ProductKindCount`

2. **ä½¿ç”¨ EXPLAIN åˆ†ææ‰§è¡Œè®¡åˆ’**ï¼šå¯å¸®åŠ©ç¡®è®¤æ˜¯å¦ä½¿ç”¨ç´¢å¼•ã€è¿æ¥é¡ºåºæ˜¯å¦åˆç†ã€‚

3. **è€ƒè™‘å°† BaseData è½åœ°ä¸ºä¸´æ—¶è¡¨**ï¼šå¯¹äºé¢‘ç¹ä½¿ç”¨çš„é€»è¾‘ï¼Œå¯ä»¥ä½¿ç”¨ä¸´æ—¶è¡¨ç¼“å­˜ BaseData å†…å®¹ï¼Œé¿å…é‡å¤è®¡ç®—ã€‚

---

## âœ… æ€»ç»“

é€šè¿‡ç»“æ„é‡æ„ï¼ˆCTEï¼‰ã€é€»è¾‘æ‹†åˆ†ä¸ç´¢å¼•ä¼˜åŒ–ï¼Œæˆ‘ä»¬å°†ä¸€ä¸ªå¤æ‚çš„ SQL æŸ¥è¯¢å˜å¾—æ›´é«˜æ•ˆã€æ›´æ¸…æ™°ã€‚å¦‚æœä½ åœ¨å¤„ç†å¤æ‚èšåˆæŸ¥è¯¢æ—¶é‡åˆ°æ€§èƒ½ç“¶é¢ˆï¼Œä¸å¦¨å°è¯•è¿™ç§æ–¹å¼è¿›è¡Œé‡æ„ã€‚
