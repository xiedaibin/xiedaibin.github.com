---
layout: page
title: C# ä¸­ä»€ä¹ˆæ—¶å€™è¯¥ç”¨ Taskï¼Œä»€ä¹ˆæ—¶å€™è¯¥ç”¨ ValueTaskï¼Ÿ
category: æŠ€æœ¯
tags: net

åœ¨ç°ä»£ C# / .NET å¼€å‘ä¸­ï¼Œ`async/await` å·²ç»æˆä¸ºæ—¥å¸¸ç¼–ç çš„ä¸€éƒ¨åˆ†ï¼Œè€Œ `Task` å‡ ä¹æ˜¯æ‰€æœ‰å¼‚æ­¥æ–¹æ³•çš„é»˜è®¤è¿”å›ç±»å‹ã€‚

éšç€ .NET çš„æ¼”è¿›ï¼Œ`ValueTask` è¢«å¼•å…¥ï¼Œå¾ˆå¤šå¼€å‘è€…å¼€å§‹å›°æƒ‘ï¼š

* æˆ‘æ˜¯ä¸æ˜¯åº”è¯¥æŠŠæ‰€æœ‰ `Task` éƒ½æ¢æˆ `ValueTask`ï¼Ÿ
* è¿”å› `bool` è¿™ä¹ˆç®€å•çš„ç»“æœï¼Œç”¨ `ValueTask<bool>` ä¼šä¸ä¼šæ›´é«˜æ•ˆï¼Ÿ
* ä¸šåŠ¡ä»£ç ä¸­åˆ°åº•è¯¥ä¸è¯¥ç”¨ `ValueTask`ï¼Ÿ

è¿™ç¯‡æ–‡ç« ä¼šç³»ç»Ÿåœ°è®²æ¸…æ¥š **Task ä¸ ValueTask çš„åŒºåˆ«ã€è”ç³»ã€é€‚ç”¨åœºæ™¯ä»¥åŠå¸¸è§è¯¯åŒº**ï¼Œç»™ä½ ä¸€å¥—å¯ç›´æ¥ç”¨äºä»£ç è¯„å®¡å’Œæ¶æ„è®¾è®¡çš„åˆ¤æ–­æ ‡å‡†ã€‚

---

## ä¸€ã€ä¸€å¥è¯ç»“è®ºï¼ˆå…ˆç»™ç­”æ¡ˆï¼‰

* âœ… **ç»å¤§å¤šæ•°åœºæ™¯ï¼šä½¿ç”¨ `Task / Task<T>`**
* âš ï¸ **åªæœ‰åœ¨æ˜ç¡®çš„æ€§èƒ½ç“¶é¢ˆä¸‹ï¼Œæ‰è€ƒè™‘ `ValueTask / ValueTask<T>`**
* âŒ **è¿”å›çš„æ˜¯ `bool`ï¼Œå¹¶ä¸æ˜¯ä½¿ç”¨ `ValueTask<bool>` çš„ç†ç”±**

> **`ValueTask` æ˜¯æ€§èƒ½ä¼˜åŒ–å·¥å…·ï¼Œè€Œä¸æ˜¯æ–°çš„é»˜è®¤æ ‡å‡†ã€‚**

---

## äºŒã€Task ä¸ ValueTask çš„æœ¬è´¨åŒºåˆ«

### 1. Task æ˜¯ä»€ä¹ˆï¼Ÿ

* å¼•ç”¨ç±»å‹ï¼ˆ`class`ï¼‰
* è¡¨ç¤ºä¸€ä¸ªâ€œå¯èƒ½å¼‚æ­¥å®Œæˆâ€çš„æ“ä½œ
* å³ä¾¿æ–¹æ³•åŒæ­¥å®Œæˆï¼Œä¹Ÿéœ€è¦ï¼š

  * åˆ†é…ä¸€ä¸ª `Task` å¯¹è±¡ï¼Œæˆ–
  * ä½¿ç”¨ç¼“å­˜çš„ `Task`ï¼ˆå¦‚ `Task.CompletedTask`ã€`Task.FromResult`ï¼‰

```csharp
Task<bool> CheckAsync()
{
    return Task.FromResult(true);
}
```

ä¼˜ç‚¹å¾ˆæ˜æ˜¾ï¼š

* è¯­ä¹‰æ¸…æ™°
* API ä¸°å¯Œ
* ä½¿ç”¨å®‰å…¨
* å‡ ä¹ä¸ä¼šè¢«è¯¯ç”¨

---

### 2. ValueTask æ˜¯ä»€ä¹ˆï¼Ÿ

* å€¼ç±»å‹ï¼ˆ`struct`ï¼‰
* å†…éƒ¨å¯ä»¥ï¼š

  * ç›´æ¥ä¿å­˜åŒæ­¥ç»“æœ
  * æˆ–åŒ…è£…ä¸€ä¸ª `Task`
* è®¾è®¡ç›®æ ‡æ˜¯ï¼š

> **åœ¨â€œé«˜é¢‘ä¸”åŒæ­¥å®Œæˆâ€çš„åœºæ™¯ä¸‹ï¼Œé¿å…ä¸å¿…è¦çš„ Task å¯¹è±¡åˆ†é…**

```csharp
ValueTask<bool> CheckAsync()
{
    return new ValueTask<bool>(true);
}
```

---

## ä¸‰ã€æœ€å®¹æ˜“è¢«å¿½ç•¥ï¼Œä½†æœ€é‡è¦çš„åŒºåˆ«

### 1ï¸âƒ£ ValueTask é»˜è®¤åªèƒ½è¢« await ä¸€æ¬¡

```csharp
ValueTask<int> vt = GetAsync();

await vt; // âœ…
await vt; // âŒ æœªå®šä¹‰è¡Œä¸ºï¼Œå¯èƒ½ç›´æ¥æŠ›å¼‚å¸¸
```

è€Œ `Task` å¯ä»¥è¢«å®‰å…¨åœ°å¤šæ¬¡ awaitã€‚

è¿™æ„å‘³ç€ï¼š

* `ValueTask` **ä¸é€‚åˆä½œä¸ºå…¬å…± API è¿”å›ç±»å‹**
* éå¸¸å®¹æ˜“è¢«è°ƒç”¨æ–¹è¯¯ç”¨

---

### 2ï¸âƒ£ ç»„åˆæ“ä½œå¯¹ ValueTask éå¸¸ä¸å‹å¥½

ä¸‹é¢è¿™äº›å¯¹ `Task` æ¥è¯´æ˜¯å®¶å¸¸ä¾¿é¥­ï¼š

```csharp
await Task.WhenAll(task1, task2);
await Task.WhenAny(task1, task2);
```

è€Œ `ValueTask`ï¼š

* æ²¡æœ‰ `WhenAll(ValueTask)`
* é€šå¸¸åªèƒ½ `.AsTask()` å†å‚ä¸ç»„åˆ

```csharp
await Task.WhenAll(vt1.AsTask(), vt2.AsTask());
```

ä¸€æ—¦ `AsTask()`ï¼š

> **ValueTask çš„æ€§èƒ½ä¼˜åŠ¿ç›´æ¥å½’é›¶**

---

### 3ï¸âƒ£ ValueTask å¢åŠ äº†å¿ƒæ™ºè´Ÿæ‹…

ä½¿ç”¨ `ValueTask` æ—¶ï¼Œä½ å¿…é¡»é¢å¤–ç¡®ä¿ï¼š

* ä¸è¢«å¤šæ¬¡ await
* ä¸è¢«ç¼“å­˜
* ä¸è¢«éšæ„ä¼ é€’

åœ¨ä¸šåŠ¡ä»£ç ä¸­ï¼Œè¿™ç§å¤æ‚åº¦é€šå¸¸æ˜¯å¾—ä¸å¿å¤±çš„ã€‚

---

## å››ã€ä»€ä¹ˆæ—¶å€™â€œåº”è¯¥â€ä½¿ç”¨ ValueTaskï¼Ÿ

### å”¯ä¸€å€¼å¾—æ¨èçš„æ ¸å¿ƒåœºæ™¯

> **é«˜é¢‘è°ƒç”¨ + å¤§æ¦‚ç‡åŒæ­¥å®Œæˆ + æ€§èƒ½æ•æ„Ÿ**

---

### åœºæ™¯ä¸€ï¼šåº•å±‚åº“ / åŸºç¡€è®¾æ–½ä»£ç 

.NET BCL ä¸­çš„ç»å…¸ä¾‹å­ï¼š

```csharp
ValueTask<int> ReadAsync(Memory<byte> buffer);
```

åŸå› ï¼š

* æ•°æ®å¯èƒ½å·²ç»åœ¨å†…å­˜ä¸­
* ä¸éœ€è¦çœŸæ­£çš„å¼‚æ­¥ I/O
* æ¯ç§’è°ƒç”¨æ¬¡æ•°æé«˜

---

### åœºæ™¯äºŒï¼šç¼“å­˜å‘½ä¸­ç‡æé«˜çš„é€»è¾‘

```csharp
ValueTask<User?> GetUserAsync(int id)
{
    if (_cache.TryGetValue(id, out var user))
        return new ValueTask<User?>(user);

    return new ValueTask<User?>(LoadFromDbAsync(id));
}
```

è¿™é‡Œçš„ä»·å€¼åœ¨äºï¼š

* ç¼“å­˜å‘½ä¸­ï¼š0 åˆ†é…
* ç¼“å­˜æœªå‘½ä¸­ï¼šé€€åŒ–ä¸º Task

---

## äº”ã€ä»€ä¹ˆæ—¶å€™ä¸åº”è¯¥ä½¿ç”¨ ValueTaskï¼Ÿ

### âŒ 1. ä¸šåŠ¡ä»£ç  / Controller / Application Service

```csharp
public ValueTask<bool> CreateOrderAsync() // âŒ ä¸æ¨è
```

ä¸šåŠ¡å±‚æ›´é‡è¦çš„æ˜¯ï¼š

* å¯è¯»æ€§
* å¯ç»´æŠ¤æ€§
* å¯ç»„åˆæ€§

è€Œä¸æ˜¯æé™æ€§èƒ½ã€‚

---

### âŒ 2. æ˜ç¡®çš„ I/O å¼‚æ­¥æ“ä½œ

ä¾‹å¦‚ï¼š

* HTTP è¯·æ±‚
* æ•°æ®åº“è®¿é—®
* æ–‡ä»¶ç³»ç»Ÿæ“ä½œ

```csharp
Task<bool> SaveAsync() // âœ…
```

è¿™äº›åœºæ™¯ä¸­ï¼Œ`ValueTask` å‡ ä¹æ²¡æœ‰ä»»ä½•æ”¶ç›Šã€‚

---

### âŒ 3. å…¬å…± API / SDK æ¥å£

é™¤éä½ èƒ½å®Œå…¨æ§åˆ¶è°ƒç”¨æ–¹å¼ï¼Œå¦åˆ™ï¼š

```csharp
Task<T> // æ°¸è¿œæ˜¯æ›´å®‰å…¨çš„é€‰æ‹©
```

---

## å…­ã€é‡ç‚¹é—®é¢˜ï¼šè¿”å› boolï¼Œè¦ä¸è¦ç”¨ ValueTask<bool>ï¼Ÿ

### ç­”æ¡ˆï¼šä¸éœ€è¦ï¼Œç»å¯¹ä¸æ˜¯

æ˜¯å¦ä½¿ç”¨ `ValueTask<bool>`ï¼Œ**ä¸è¿”å›ç±»å‹æ˜¯ä¸æ˜¯ bool æ²¡æœ‰ä»»ä½•ç›´æ¥å…³ç³»**ã€‚

å”¯ä¸€çš„åˆ¤æ–­ä¾æ®æ˜¯ï¼š

> **è¿™ä¸ªæ–¹æ³•æ˜¯å¦é«˜é¢‘è°ƒç”¨ï¼Œä¸”å¤§å¤šæ•°æƒ…å†µä¸‹åŒæ­¥å®Œæˆï¼Ÿ**

---

### æ­£ç¡®ç¤ºä¾‹ï¼ˆå¯è€ƒè™‘ ValueTaskï¼‰

```csharp
ValueTask<bool> IsFeatureEnabledAsync()
{
    if (_configCached)
        return new ValueTask<bool>(true);

    return new ValueTask<bool>(LoadFromRemoteAsync());
}
```

---

### é”™è¯¯ç¤ºä¾‹ï¼ˆå¸¸è§è¯¯ç”¨ï¼‰

```csharp
// âŒ åªæ˜¯å› ä¸ºè¿”å› bool
public ValueTask<bool> ExistsAsync(int id)
{
    return new ValueTask<bool>(_db.ExistsAsync(id));
}
```

è¿™ä¸ªå†™æ³•ï¼š

* æ²¡æœ‰å‡å°‘åˆ†é…
* å¢åŠ äº†å¤æ‚åº¦
* æ²¡æœ‰ä»»ä½•æ€§èƒ½æ”¶ç›Š

---

## ä¸ƒã€æ¨èçš„å®è·µå‡†åˆ™ï¼ˆå¯ç›´æ¥ç”¨äº Code Reviewï¼‰

### âœ” é»˜è®¤è§„åˆ™

> **99% çš„ async æ–¹æ³•ï¼šä½¿ç”¨ `Task / Task<T>`**

---

### âœ” åªæœ‰åœ¨åŒæ—¶æ»¡è¶³ä»¥ä¸‹æ¡ä»¶æ—¶ï¼Œæ‰è€ƒè™‘ ValueTask

* è°ƒç”¨é¢‘ç‡æé«˜ï¼ˆä¾‹å¦‚æ¯ç§’æˆåƒä¸Šä¸‡æ¬¡ï¼‰
* å¤§å¤šæ•°æƒ…å†µä¸‹åŒæ­¥å®Œæˆ
* æ€§èƒ½åˆ†æå·¥å…·ï¼ˆBenchmark / Profilerï¼‰è¯æ˜æœ‰ä»·å€¼
* è°ƒç”¨æ–¹å®Œå…¨å¯æ§

---

## å…«ã€æ€»ç»“

* `Task` æ˜¯**å®‰å…¨ã€æ˜“ç”¨ã€å¯ç»„åˆ**çš„é€šç”¨æŠ½è±¡
* `ValueTask` æ˜¯**ä¸ºæç«¯æ€§èƒ½åœºæ™¯å‡†å¤‡çš„ä¼˜åŒ–å·¥å…·**
* **ä¸è¦ä¸ºäº†â€œçœ‹èµ·æ¥é«˜çº§â€è€Œä½¿ç”¨ ValueTask**

> **å…ˆå†™å¯¹ï¼Œå†å†™å¿«ï¼›
> æ²¡æœ‰æ€§èƒ½æ•°æ®æ”¯æ’‘çš„ä¼˜åŒ–ï¼Œé€šå¸¸éƒ½æ˜¯è´Ÿä¼˜åŒ–ã€‚**

å¦‚æœä½ åœ¨ ASP.NET Coreã€ABPã€æˆ–è€…é«˜å¹¶å‘æœåŠ¡ä¸­é‡åˆ°å…·ä½“åœºæ™¯ï¼Œä¸ç¡®å®šæ˜¯å¦è¯¥ç”¨ `ValueTask`ï¼Œé‚£å¾€å¾€æ„å‘³ç€ï¼š

ğŸ‘‰ **ä½ åº”è¯¥ç»§ç»­ç”¨ Taskã€‚**
